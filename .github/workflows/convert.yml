name: Convert Rules

on:
  push:
    paths:
      - 'src/**.list'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ğŸ‘‡ã€ä¿®æ”¹ç‚¹ã€‘åºŸå¼ƒä¸ç¨³å®šçš„ wgetï¼Œæ”¹ç”¨ Go ç¼–è¯‘å®‰è£…ï¼Œç¨³å¦‚è€ç‹—
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install Sing-box
        run: |
          echo "Installing Sing-box via Go..."
          # ä½¿ç”¨ Go å®˜æ–¹ä»£ç†å®‰è£…ï¼Œé€Ÿåº¦å¿«ä¸”ç¨³å®š
          go install -v -tags with_quic,with_dhcp,with_wireguard,with_shadowsocksr,with_ech,with_utls,with_reality_server,with_clash_api,with_gvisor github.com/sagernet/sing-box/cmd/sing-box@v1.11.4
          
          # éªŒè¯å®‰è£…æ˜¯å¦æˆåŠŸ
          $(go env GOPATH)/bin/sing-box version

      - name: Run Conversion Script
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Execute Python Script
        run: |
          # å°† GOPATH/bin åŠ å…¥ PATHï¼Œç¡®ä¿èƒ½æ‰¾åˆ° sing-box
          export PATH=$(go env GOPATH)/bin:$PATH
          
          python -c "
          import glob, json, os, subprocess, sys

          os.makedirs('rule_json', exist_ok=True)
          os.makedirs('rule_srs', exist_ok=True)

          files = glob.glob('src/*.list')
          if not files:
              print('âš ï¸ Warning: No .list files found in src/ folder!')
              sys.exit(0)

          print(f'Found {len(files)} list files. Processing...')
          
          has_error = False

          for list_file in files:
              filename = os.path.basename(list_file).replace('.list', '')
              print(f'--------------------------------------')
              print(f'Processing {filename}...')
              
              rules = []
              try:
                  # ä½¿ç”¨ utf-8-sig å»é™¤ BOM å¤´
                  with open(list_file, 'r', encoding='utf-8-sig') as f:
                      for line in f:
                          line = line.strip()
                          if not line or line.startswith('#'): continue
                          parts = line.split(',')
                          if len(parts) < 2: continue
                          
                          r_type = parts[0].upper().strip()
                          r_val = parts[1].strip()
                          
                          # --- æ ¸å¿ƒä¿®å¤ï¼šæ‰‹åŠ¨æ˜ å°„ç±»å‹ï¼Œé˜²æ­¢å‡ºç° ip_cidr6 ---
                          if r_type == 'DOMAIN-SUFFIX':
                              rules.append({'domain_suffix': r_val})
                          elif r_type == 'DOMAIN-KEYWORD':
                              rules.append({'domain_keyword': r_val})
                          elif r_type == 'DOMAIN':
                              rules.append({'domain': r_val})
                          elif r_type == 'IP-CIDR' or r_type == 'IP-CIDR6':
                              # IPv6 ä¹Ÿè¦æ”¾è¿› ip_cidr å­—æ®µé‡Œ
                              rules.append({'ip_cidr': r_val})
                          elif r_type == 'IP-ASN':
                              rules.append({'ip_asn': r_val})
                              
              except Exception as e:
                  print(f'âŒ Read Error: {e}')
                  has_error = True
                  continue

              if not rules:
                  print(f'âš ï¸ Skipping {filename}: No valid rules found.')
                  continue

              final_rule = {}
              for r in rules:
                  for k, v in r.items():
                      if k not in final_rule: final_rule[k] = []
                      final_rule[k].append(v)
              
              json_data = {'version': 1, 'rules': [final_rule]}
              
              # ä¿å­˜ JSON
              json_path = f'rule_json/{filename}.json'
              with open(json_path, 'w', encoding='utf-8') as jf:
                  json.dump(json_data, jf, indent=2)
              print(f'âœ… JSON Generated: {json_path}')

              # ç¼–è¯‘ SRS
              srs_path = f'rule_srs/{filename}.srs'
              try:
                  # ç›´æ¥è°ƒç”¨ sing-box (å› ä¸ºå·²åŠ å…¥ PATH)
                  result = subprocess.run(
                      ['sing-box', 'rule-set', 'compile', json_path, '-o', srs_path],
                      check=True, capture_output=True, text=True
                  )
                  print(f'âœ… SRS Compiled: {srs_path}')
              except subprocess.CalledProcessError as e:
                  print(f'âŒ Compilation Failed for {filename}!')
                  print(f'ğŸ‘‰ Error Message: {e.stderr}')
                  has_error = True

          if has_error:
              print('âŒ Some files failed to process.')
              sys.exit(1)
          else:
              print('ğŸ‰ All files processed successfully.')
          "

      - name: Commit and Push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add rule_json/ rule_srs/ || true
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Auto update rules [skip ci]"
            git push
          fi
