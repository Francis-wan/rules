name: Update convert Rules

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # 每天运行一次
  push:
    paths:
      - 'rule_json/**' # 当 json 修改时触发

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout codebase
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install Sing-box
        run: |
          echo "Installing Sing-box..."
          go install -v -tags with_quic,with_dhcp,with_wireguard,with_shadowsocksr,with_ech,with_utls,with_reality_server,with_clash_api,with_gvisor github.com/sagernet/sing-box/cmd/sing-box@latest
          sing-box version

      - name: Compile SRS
        run: |
          mkdir -p rule_srs
          
          # 遍历 rule_json 下的所有 .json 文件
          for file in rule_json/*.json; do
            filename=$(basename "$file" .json)
            echo "--------------------------------------"
            echo "正在编译: $filename"
            
            # 编译命令：json -> srs
            # 如果编译失败，脚本会立即停止，不会提交坏文件
            sing-box rule-set compile "$file" -o "rule_srs/$filename.srs" || exit 1
            
            # 打印生成的文件大小，方便检查
            filesize=$(ls -lh "rule_srs/$filename.srs" | awk '{print $5}')
            echo "✅ 编译成功: rule_srs/$filename.srs (大小: $filesize)"
          done

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add rule_srs/*.srs
          
          # 只有当有变化时才提交
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Auto-update SRS rules [$(date)]"
            git push
          fi
