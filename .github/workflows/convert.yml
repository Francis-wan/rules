name: Convert Rules

# ğŸ‘‡ è§¦å‘æœºåˆ¶ä¿®æ­£ï¼šä¿è¯æ”¹ä»€ä¹ˆéƒ½èƒ½è·‘
on:
  push:
    branches:
      - main
    paths:
      - 'src/**.list'          # ç›‘å¬æºæ–‡ä»¶ä¿®æ”¹
      - '.github/workflows/**'  # ç›‘å¬è„šæœ¬æœ¬èº«ä¿®æ”¹
  workflow_dispatch:            # âœ… å¢åŠ æ‰‹åŠ¨è§¦å‘æŒ‰é’® (æ•‘å‘½ç”¨)

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # âœ… å¿…é¡»æœ‰å†™å…¥æƒé™ï¼Œå¦åˆ™æ— æ³•æäº¤ç”Ÿæˆçš„æ–‡ä»¶

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. ä¸‹è½½ Sing-box æ ¸å¿ƒ (ç¼–è¯‘å™¨)
      - name: Download Sing-box Binary
        run: |
          VERSION="1.10.1"
          echo "Downloading sing-box v$VERSION..."
          wget https://github.com/SagerNet/sing-box/releases/download/v${VERSION}/sing-box-${VERSION}-linux-amd64.tar.gz
          tar -xvf sing-box-${VERSION}-linux-amd64.tar.gz
          mv sing-box-${VERSION}-linux-amd64/sing-box .
          chmod +x sing-box
          ./sing-box version

      # 2. æ ¸å¿ƒé€»è¾‘ï¼šPython åŒæ—¶ç”Ÿæˆ JSON å’Œ SRS
      - name: Run Conversion Script
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Execute Python Script
        run: |
          python -c "
          import glob, json, os, subprocess

          # å‡†å¤‡æ–‡ä»¶å¤¹
          os.makedirs('rule_json', exist_ok=True)
          os.makedirs('rule_srs', exist_ok=True)

          # éå† src ä¸‹çš„æ‰€æœ‰ .list æ–‡ä»¶
          for list_file in glob.glob('src/*.list'):
              filename = os.path.basename(list_file).replace('.list', '')
              print(f'Processing {filename}...')
              
              rules = []
              # è¯»å– List æ–‡ä»¶
              try:
                  with open(list_file, 'r', encoding='utf-8') as f:
                      for line in f:
                          line = line.strip()
                          if not line or line.startswith('#'): continue
                          parts = line.split(',')
                          if len(parts) < 2: continue
                          
                          # å…¼å®¹ DOMAIN-SUFFIX, IP-CIDR ç­‰å†™æ³•
                          r_type = parts[0].upper().replace('-', '_').lower()
                          r_val = parts[1].strip()
                          
                          # æ„é€  sing-box è§„åˆ™å¯¹è±¡
                          if 'domain' in r_type:
                              rules.append({r_type: r_val})
                          elif 'ip' in r_type:
                              rules.append({r_type: r_val})
                              
              except Exception as e:
                  print(f'Error reading {list_file}: {e}')
                  continue

              if not rules:
                  print(f'Skipping {filename}: No rules found.')
                  continue

              # --- å…³é”®ç‚¹ï¼šåˆå¹¶åŒç±»é¡¹ç”Ÿæˆ JSON ---
              # ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬ç›´æ¥ç”Ÿæˆ standard json structure
              final_rule = {}
              for r in rules:
                  for k, v in r.items():
                      if k not in final_rule: final_rule[k] = []
                      final_rule[k].append(v)
              
              json_data = {'version': 1, 'rules': [final_rule]}
              
              # 1. ä¿å­˜ JSON (ç»™ my_proxy ç”¨)
              json_path = f'rule_json/{filename}.json'
              with open(json_path, 'w', encoding='utf-8') as jf:
                  json.dump(json_data, jf, indent=2)
              print(f'âœ… Generated JSON: {json_path}')

              # 2. ç¼–è¯‘ SRS (ç»™ bm7_proxy ç”¨)
              srs_path = f'rule_srs/{filename}.srs'
              try:
                  subprocess.run(['./sing-box', 'rule-set', 'compile', json_path, '-o', srs_path], check=True)
                  print(f'âœ… Compiled SRS: {srs_path}')
              except subprocess.CalledProcessError:
                  print(f'âŒ Failed to compile {filename}')
                  exit(1)
          "

      # 3. æäº¤ç»“æœå›ä»“åº“
      - name: Commit and Push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          # å¼ºåˆ¶æ·»åŠ è¿™ä¸¤ä¸ªæ–‡ä»¶å¤¹ï¼Œä¸ç®¡æœ‰æ²¡æœ‰ .gitignore
          git add -f rule_json/*.json 
          git add -f rule_srs/*.srs
          
          # åªæœ‰å½“æœ‰å˜åŒ–æ—¶æ‰ commitï¼Œé˜²æ­¢æŠ¥é”™
          git diff-index --quiet HEAD || git commit -m "Auto update rules: JSON + SRS"
          git push origin HEAD:main
