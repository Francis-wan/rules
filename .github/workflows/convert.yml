name: Convert Rules

on:
  push:
    paths:
      - 'src/**.list'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Sing-box Binary
        run: |
          # å‡çº§åˆ°ä¸€ä¸ªè¾ƒæ–°çš„ç¨³å®šç‰ˆï¼Œå…¼å®¹æ€§æ›´å¥½
          VERSION="1.11.4"
          echo "Downloading sing-box v$VERSION..."
          wget https://github.com/SagerNet/sing-box/releases/download/v${VERSION}/sing-box-${VERSION}-linux-amd64.tar.gz
          tar -xvf sing-box-${VERSION}-linux-amd64.tar.gz
          # ç§»åŠ¨å¹¶é‡å‘½åï¼Œç¡®ä¿è·¯å¾„ç®€å•
          mv sing-box-${VERSION}-linux-amd64/sing-box .
          chmod +x sing-box
          ./sing-box version

      - name: Run Conversion Script
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Execute Python Script
        run: |
          python -c "
          import glob, json, os, subprocess, sys

          os.makedirs('rule_json', exist_ok=True)
          os.makedirs('rule_srs', exist_ok=True)

          files = glob.glob('src/*.list')
          if not files:
              print('âš ï¸ Warning: No .list files found in src/ folder!')
              sys.exit(0)

          print(f'Found {len(files)} list files. Processing...')
          
          has_error = False

          for list_file in files:
              filename = os.path.basename(list_file).replace('.list', '')
              print(f'--------------------------------------')
              print(f'Processing {filename}...')
              
              rules = []
              try:
                  # âœ… å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨ utf-8-sig è‡ªåŠ¨å»é™¤ BOM å¤´ï¼Œé˜²æ­¢ä¹±ç æŠ¥é”™
                  with open(list_file, 'r', encoding='utf-8-sig') as f:
                      for line in f:
                          line = line.strip()
                          if not line or line.startswith('#'): continue
                          parts = line.split(',')
                          if len(parts) < 2: continue
                          
                          # å…¼å®¹å¤„ç†ï¼šæŠŠ DOMAIN-SUFFIX è½¬ä¸º domain_suffix
                          r_type = parts[0].upper().replace('-', '_').lower()
                          r_val = parts[1].strip()
                          
                          # åªä¿ç•™ domain å’Œ ip ç›¸å…³çš„è§„åˆ™
                          if 'domain' in r_type:
                              rules.append({r_type: r_val})
                          elif 'ip' in r_type:
                              rules.append({r_type: r_val})
                              
              except Exception as e:
                  print(f'âŒ Read Error: {e}')
                  has_error = True
                  continue

              if not rules:
                  print(f'âš ï¸ Skipping {filename}: No valid rules found.')
                  continue

              # åˆå¹¶è§„åˆ™ç”Ÿæˆ JSON
              final_rule = {}
              for r in rules:
                  for k, v in r.items():
                      if k not in final_rule: final_rule[k] = []
                      final_rule[k].append(v)
              
              json_data = {'version': 1, 'rules': [final_rule]}
              
              # ä¿å­˜ JSON
              json_path = f'rule_json/{filename}.json'
              with open(json_path, 'w', encoding='utf-8') as jf:
                  json.dump(json_data, jf, indent=2)
              print(f'âœ… JSON Generated: {json_path}')

              # ç¼–è¯‘ SRS
              srs_path = f'rule_srs/{filename}.srs'
              try:
                  # âœ… å…³é”®ä¿®æ”¹ï¼šæ•è·è¯¦ç»†æŠ¥é”™ä¿¡æ¯ (stderr)
                  result = subprocess.run(
                      ['./sing-box', 'rule-set', 'compile', json_path, '-o', srs_path],
                      check=True, capture_output=True, text=True
                  )
                  print(f'âœ… SRS Compiled: {srs_path}')
              except subprocess.CalledProcessError as e:
                  print(f'âŒ Compilation Failed for {filename}!')
                  print(f'ğŸ‘‰ Error Message: {e.stderr}') # æ‰“å°å…·ä½“åŸå› 
                  has_error = True

          if has_error:
              print('âŒ Some files failed to process. Check logs above.')
              # å“ªæ€•æœ‰é”™ï¼Œä¹Ÿå°½é‡æäº¤æˆåŠŸçš„é‚£äº›æ–‡ä»¶ï¼Œæ–¹ä¾¿ä½ è°ƒè¯•
          else:
              print('ğŸ‰ All files processed successfully.')
          "

      - name: Commit and Push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add rule_json/ rule_srs/ || true
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Auto update rules [skip ci]"
            git push
            echo "ğŸ‰ Pushed changes to GitHub."
          fi
