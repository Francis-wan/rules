name: Convert Rules

on:
  push:
    paths:
      - 'src/**.list'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Sing-box Binary
        run: |
          VERSION="1.11.4"
          echo "Downloading sing-box v$VERSION..."
          wget https://github.com/SagerNet/sing-box/releases/download/v${VERSION}/sing-box-${VERSION}-linux-amd64.tar.gz
          tar -xvf sing-box-${VERSION}-linux-amd64.tar.gz
          mv sing-box-${VERSION}-linux-amd64/sing-box .
          chmod +x sing-box
          ./sing-box version

      - name: Run Conversion Script
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Execute Python Script
        run: |
          python -c "
          import glob, json, os, subprocess, sys

          os.makedirs('rule_json', exist_ok=True)
          os.makedirs('rule_srs', exist_ok=True)

          files = glob.glob('src/*.list')
          if not files:
              print('‚ö†Ô∏è Warning: No .list files found in src/ folder!')
              sys.exit(0)

          print(f'Found {len(files)} list files. Processing...')
          
          has_error = False

          for list_file in files:
              filename = os.path.basename(list_file).replace('.list', '')
              print(f'--------------------------------------')
              print(f'Processing {filename}...')
              
              rules = []
              try:
                  # ‰ΩøÁî® utf-8-sig ÂéªÈô§ BOM Â§¥
                  with open(list_file, 'r', encoding='utf-8-sig') as f:
                      for line in f:
                          line = line.strip()
                          if not line or line.startswith('#'): continue
                          parts = line.split(',')
                          if len(parts) < 2: continue
                          
                          # Ëé∑ÂèñÁ±ªÂûãÂíåÂÄº
                          r_type = parts[0].upper().strip()
                          r_val = parts[1].strip()
                          
                          # --- Ê†∏ÂøÉ‰øÆÂ§çÔºöÊâãÂä®Êò†Â∞ÑÁ±ªÂûãÔºåÈò≤Ê≠¢Âá∫Áé∞ ip_cidr6 ---
                          if r_type == 'DOMAIN-SUFFIX':
                              rules.append({'domain_suffix': r_val})
                          elif r_type == 'DOMAIN-KEYWORD':
                              rules.append({'domain_keyword': r_val})
                          elif r_type == 'DOMAIN':
                              rules.append({'domain': r_val})
                          elif r_type == 'IP-CIDR' or r_type == 'IP-CIDR6':
                              # ‚úÖ ÈáçÁÇπÔºöIPv6 ‰πüË¶ÅÊîæËøõ ip_cidr Â≠óÊÆµÈáåÔºÅ
                              rules.append({'ip_cidr': r_val})
                          elif r_type == 'IP-ASN':
                              rules.append({'ip_asn': r_val})
                              
              except Exception as e:
                  print(f'‚ùå Read Error: {e}')
                  has_error = True
                  continue

              if not rules:
                  print(f'‚ö†Ô∏è Skipping {filename}: No valid rules found.')
                  continue

              # ÂêàÂπ∂ËßÑÂàô
              final_rule = {}
              for r in rules:
                  for k, v in r.items():
                      if k not in final_rule: final_rule[k] = []
                      final_rule[k].append(v)
              
              json_data = {'version': 1, 'rules': [final_rule]}
              
              # ‰øùÂ≠ò JSON
              json_path = f'rule_json/{filename}.json'
              with open(json_path, 'w', encoding='utf-8') as jf:
                  json.dump(json_data, jf, indent=2)
              print(f'‚úÖ JSON Generated: {json_path}')

              # ÁºñËØë SRS
              srs_path = f'rule_srs/{filename}.srs'
              try:
                  result = subprocess.run(
                      ['./sing-box', 'rule-set', 'compile', json_path, '-o', srs_path],
                      check=True, capture_output=True, text=True
                  )
                  print(f'‚úÖ SRS Compiled: {srs_path}')
              except subprocess.CalledProcessError as e:
                  print(f'‚ùå Compilation Failed for {filename}!')
                  print(f'üëâ Error Message: {e.stderr}')
                  has_error = True

          if has_error:
              print('‚ùå Some files failed to process.')
              sys.exit(1) # Êä•ÈîôÈÄÄÂá∫ÔºåËÆ©‰Ω†Âú® Actions È°µÈù¢ËÉΩÁúãÂà∞Á∫¢Âèâ
          else:
              print('üéâ All files processed successfully.')
          "

      - name: Commit and Push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add rule_json/ rule_srs/ || true
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Auto update rules [skip ci]"
            git push
          fi
